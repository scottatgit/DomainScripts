
#Log into Azure - very raw file - runs from cloudshell and some vars are hardcoded

Add-AzAccount



#Select the correct subscription

Get-AzSubscription -SubscriptionName "Microsoft Azure Workstation Services" | Select-AzSubscription



#Variables for vault and vm
$prefix = "ced"

$Location = "eastus"

$id = Get-Random -Minimum 1000 -Maximum 9999

$ResourceGroupName = "cloud-shell-storage-eastus"

$VMName = "delete03102020"



#Now provision a Key Vault if you don't already have one



#Create a new Key Vault

$keyVaultParameters = @{

    Name = "$prefix-key-vault-$id"

    ResourceGroupName = "cloud-shell-storage-eastus"

    Location = $location

    EnabledForDiskEncryption = $true

    EnabledForDeployment = $true

    Sku = "Standard"

}

$keyVault = New-AzKeyVault @keyVaultParameters



#Set the disk encryption settings for the Windows VM

$DiskEncryptionParameters = @{

    ResourceGroupName = "cloud-shell-storage-eastus"

    VMname = $VMName

    DiskEncryptionKeyVaultUrl = $keyVault.VaultUri

    DiskEncryptionKeyVaultId = $keyVault.ResourceId

    VolumeType = "All"

}



Set-AzVMDiskEncryptionExtension @DiskEncryptionParameters
#RBAC Permissions - objectId is the aad dc admin group id or specific user needing access
Set-AzureRmKeyVaultAccessPolicy -VaultName "keyvaultfordeleteVM" -ResourceGroupName "cloud-shell-storage-eastus" -ObjectId "180450a8-9376-4bb7-9051-a89ff869e37d" -PermissionsToKeys list -PermissionsToSecrets list



#Check the encryption settings once the command completes

Get-AzVmDiskEncryptionStatus -ResourceGroupName "cloud-shell-storage-eastus" -VMName $VMName



